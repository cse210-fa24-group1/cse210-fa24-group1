<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: dist/scripts/auth.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: dist/scripts/auth.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Authentication module handling user registration and login functionality
 * using localStorage for data persistence.
 * @module AuthenticationModule
 */
(function () {
  /**
   * Retrieves all users from localStorage
   * @returns {Array&lt;Object>} Array of user objects
   */
  async function getUsers() {
    try {
      const response = await fetch(
        'https://budgettrackerbackend-g9gc.onrender.com/api/users'
      );
      const users = await response.json(); // Wait for the JSON data to be parsed
      return users; // Return the data after awaiting
    } catch (error) {
      // console.error('Error fetching users:', error);
      return [];
    }
  }

  /**
   * Saves or updates user data in localStorage
   * @param {Object} userData - The user data to save
   * @param {string} userData.username - User's username
   * @param {string} userData.password - User's password
   * @param {string} [userData.email] - User's email address
   * @param {string} userData.createdAt - ISO timestamp of account creation
   * @returns {void}
   */

  /**
   * Validates user credentials against stored data
   * @param {string} username - Username to validate
   * @param {string} password - Password to validate
   * @returns {Object|null} User object if credentials are valid, null otherwise
   */
  async function validateCredentials(username, password) {
    const users = await getUsers();
    // console.log(users);
    const user = users &amp;&amp; users.find((user) => user.username === username);
    // console.log(user);

    if (!user) {
      // console.log('Hi Over Here!!');
      showError('User not found. Please create an account.');
      return null;
    }

    if (user.password !== password) {
      showError('The password is incorrect.');
      return null;
    }

    return user;
  }

  /**
   * Validates password requirements and matching confirmation if on registration page
   * @returns {boolean} True if passwords are valid, false otherwise
   */
  function validatePasswords(password1, password2) {
    // const password1 = passwordInputs[0].value;
    // const password2 = passwordInputs[1]?.value;

    if (password1.length &lt; 6) {
      showError('Password must be at least 6 characters long!');
      return false;
    }

    if (!isLoginPage &amp;&amp; password1 !== password2) {
      showError('Passwords do not match!');
      return false;
    }

    return true;
  }

  /**
   * Checks if a username is available for registration
   * @param {string} username - Username to check
   * @returns {boolean} True if username is available, false if taken
   */
  async function isUsernameAvailable(username) {
    const users = await getUsers();
    return users &amp;&amp; !users.some((user) => user.username === username);
  }

  /**
   * Creates a new user session in localStoragef
   * @param {Object} user - User object for the session
   * @param {string} user.username - Username for the session
   */
  function setUserSession(user) {
    const session = {
      userId: user.userid,
      username: user.username,
      loginTime: new Date().toISOString(),
      isActive: true,
    };
    localStorage.setItem('currentSession', JSON.stringify(session));
  }

  /**
   * Checks for an existing active session and redirects to dashboard if found
   * @returns {void}
   */
  function checkExistingSession() {
    const currentSession = JSON.parse(localStorage.getItem('currentSession'));
    if (currentSession &amp;&amp; currentSession.isActive) {
      window.location.href = '../../dist/pages/home-page.html';
    }
  }

  // Determine if it's the login page based on URL or body class

  const isLoginPage = window.location.pathname.includes('index');
  // console.log(isLoginPage);
  // Select form and inputs
  const form = document.querySelector('form');
  const usernameInput = document.querySelector('#username');
  const emailInput = document.querySelector('#email');
  // Handle password inputs for both login and registration pages
  let passwordInputs;
  if (isLoginPage) {
    passwordInputs = [document.querySelector('#password')];
  } else {
    passwordInputs = document.querySelectorAll('input[type="password"]');
    if (passwordInputs[1]) {
      passwordInputs[1].id = 'password-confirm';
    }
  }

  /**
   * Handles the login form submission
   * @param {Event} e - Submit event object
   * @returns {void}
   */
  async function handleLogin(e) {
    e.preventDefault();

    const username = usernameInput.value.trim();
    const password = passwordInputs[0].value;

    if (!username || !password) {
      showError('Please fill in all fields!');
      return;
    }

    const user = await validateCredentials(username, password);

    if (user) {
      try {
        setUserSession(user);
        // showError('Login successful!');
        window.location.href = './pages/home-page.html';
      } catch (error) {
        showError('Error during login. Please try again.');
      }
    }
  }

  /**
   * Handles the registration form submission
   * @param {Event} e - Submit event object
   * @returns {void}
   */
  async function handleRegistration(e) {
    e.preventDefault();

    const username = usernameInput.value.trim();
    const email = emailInput.value.trim();
    const password = passwordInputs[0].value;

    if (!username || !password || !email) {
      showError('Please fill in all fields!');
      return;
    }

    if (!validatePasswords(passwordInputs[0].value, passwordInputs[1]?.value)) {
      return;
    }

    if (!isUsernameAvailable(username)) {
      showError('Username already exists! Please choose another one.');
      return;
    }

    try {
      await fetch('https://budgettrackerbackend-g9gc.onrender.com/api/users', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password, email }),
      });
      // showError('Account created successfully!');
      window.location.href = '../index.html';
    } catch (error) {
      showError('Error creating account. Please try again.');
    }
  }

  /**
   * Initializes event listeners and checks for existing session
   * @returns {void}
   */
  function initializeEventListeners() {
    if (form) {
      form.addEventListener(
        'submit',
        isLoginPage ? handleLogin : handleRegistration
      );
    }

    checkExistingSession();
  }

  // Initialize event listeners when DOM is fully loaded
  window.addEventListener('DOMContentLoaded', initializeEventListeners);

  // Export functions for testing
  if (typeof module !== 'undefined' &amp;&amp; module.exports) {
    module.exports = {
      getUsers,
      validateCredentials,
      validatePasswords,
      isUsernameAvailable,
      setUserSession,
      checkExistingSession,
      handleLogin,
      handleRegistration,
    };
  }
})();
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-AuthenticationModule.html">AuthenticationModule</a></li></ul><h3>Global</h3><ul><li><a href="global.html#addTransaction">addTransaction</a></li><li><a href="global.html#addTransactionDOM">addTransactionDOM</a></li><li><a href="global.html#checkBudgetLimit">checkBudgetLimit</a></li><li><a href="global.html#deleteTransaction">deleteTransaction</a></li><li><a href="global.html#getAllTransactions">getAllTransactions</a></li><li><a href="global.html#getUserTransactions">getUserTransactions</a></li><li><a href="global.html#removeTransaction">removeTransaction</a></li><li><a href="global.html#saveTransactionToDB">saveTransactionToDB</a></li><li><a href="global.html#updateUI">updateUI</a></li><li><a href="global.html#updateValues">updateValues</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Fri Dec 13 2024 07:09:06 GMT+0000 (Coordinated Universal Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
